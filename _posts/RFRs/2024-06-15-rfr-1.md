---
layout: post
title: rfr-1
published: true
---

# RFR-1: CRO Snapshot

Note: RFR standards for **Request For Research**. Its purpose is to reify (make explicit) a research problem and its expected outcome. One benefit of doing so is RFRs can be open to external contributions.

This is the very first RFR. Let’s evolve the format of RFR over time.

### Title

CRO Snapshot

### Background

The first paragraph of [Chandy & Lamport’s paper (1985)](https://lamport.azurewebsites.net/pubs/chandy.pdf) outlines the problem of taking a global snapshot of a distributed system:

> Processes in a distributed system communicate by sending and receiving messages. A process can record its own state and the messages it sends and receives; it can record
nothing else. To determine a global system state, a process p must enlist the cooperation of other processes that must record their own local states and send the recorded local states to p. All processes cannot record their local states at precisely the same instant unless they have access to a common clock. We assume that processes do not share clocks or memory. The problem is to devise algorithms by which processes record their own states and the states of communication channels so that the set of process and channel states recorded form a global system state. The global-state-detection algorithm is to be superimposed on the underlying computation: it must run concurrently with, but not alter, this underlying computation.
>

Every CRO (conflict-free replicated object) can have multiple replicas progressing asynchronously at the same time. Each replica holds a collection of updates (equivalently: a local history of the CRO), either generated locally or generated by other replicas and delivered over the network. A CRO snapshot is a singular collection of updates that represent the *current state* of the CRO.

CRO snapshots are crucial because:

1. User replicas are ephemeral. Without snapshots, once all users disconnect from a CRO, the CRO’s latest state becomes unavailable. Snapshots can be reasonably persisted by a **persistence** provider such as a blockchain.
2. Snapshot enables **compaction**. Compaction involves two parts: forwarding the state of a CRO, and pruning away the updates involved in the state forwarding. Before a replica can perform compaction of its local history of a CRO, the replica needs to know which part of the history is *safe* to prune away. What’s safe? One way to understand safety is by [causal stability](https://inria.hal.science/hal-01287738/document). However, the notion of *all* in the original definition of causal stability can be impractical. Instead, we can treat a snapshot as the safe part of the history to prune away; more specifically, all updates other than the frontier of a snapshot (frontier = the updates without parents; here we assume all updates form a partial order where the partial relation is the causal order). TL;DR snapshot enables compaction.
3. **Chain writes** are presumably enabled by snapshots. Transactions on blockchains are atomically irreversible. If a CRO wishes to generate transactions on a blockchain, it will be important that such transactions are derived from some sort of agreement among all replicas of the CRO. Snapshot represents precisely such agreement.

### Problem

1. How to take a *one-time snapshot* of a CRO with multiple running replicas?
2. How to take *periodic snapshots* of a CRO with multiple running replicas?

### Objectives

For each problem:

- devise an algorithm
- express the algorithm in both narrative form and pseudocode
- prototype the algorithm in code
- test the prototype to validate the correctness of the algorithm and to study its behavior

### Current thoughts

We have received multiple validations on the following idea towards an algorithm:

1. Run a [TLC](https://github.com/dedis/tlc) among all copies of a CRO.
2. Devise a [RAFT](https://raft.github.io/)-style algorithm on top of the TLC for replicas to reach agreement on snapshots at every tick of the TLC.

### Related works/projects

DXOS / https://dxos.org/

Anytype / https://doc.anytype.io/anytype-docs

Automerge / https://automerge.org/

### Timeline

TBD
